<script type="text/javascript">
	$(function() {
		var $productNav = $("#product-nav");
		var cycle = Math.min(3, total);

		var getCategory = function(id) {
			var i;
			for (i = 0; id > categories[i].till; i++);
			return i;
		}
		var getImageDimensions = function(at){
			var height, width;

			height = Math.max(.4 * $(window).height(), Math.min(dimensions[at - 1].height, .7 * $(window).height()));
			width = Math.max(.3 * $(window).width(), Math.min(dimensions[at - 1].width, .6 * $(window).width()));
			height = Math.min(height, width * dimensions[at - 1].height / dimensions[at - 1].width);
			width = Math.min(width, height * dimensions[at - 1].width / dimensions[at - 1].height);
			return {
				height: height,
				width: width
			}
		}
		var imageChangeTimeout;
		var updateImage = function(at) {
			var el = $('#product-picture').find('> .image');
			el.css('opacity', '0');
			var currentImageDimensions = getImageDimensions(at);
			var categoryIndex = getCategory(at);
			$('#breadcrumb').find('> .category').html(categories[categoryIndex].name).attr('href', '/catalogue/' + categories[categoryIndex].name);
			clearTimeout(imageChangeTimeout);
			imageChangeTimeout = setTimeout(function() {
				el.css({
					'background-image': '' +
						'url("/img/product/' +
						categories[categoryIndex].name +
						'/' +
						(at - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)) +
						'.png' +
						'")',
					'background-size' : currentImageDimensions.width + 'px ' + currentImageDimensions.height + 'px'
				});
				el.animate({
						"height": currentImageDimensions.height,
						"width": currentImageDimensions.width
					},
					500);
				el.css('opacity', '1');
			}, 500);
		}
		for (var d = -1; d < Math.min(cycle - 1, total - 1); d++) {
			var AT = (((at + total + d - 1) % total) + 1);
			var categoryIndex = getCategory(AT);
			$productNav.append('' +
				'<img src="/img/imgmin/product/' +
				categories[categoryIndex].name +
				'/' +
				(AT - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)) +
				'.png" />' +
				'');
		}
		if (total === 1) $productNav.find("> img:nth-child(1)").css("opacity", "1");
		updateImage(at);
		$productNav.find("> img").off('click');
		$productNav.find("> img:first-child").on('click', function() {changeProduct(-1);});
		$productNav.find("> img:last-child").on('click', function() {changeProduct(1);});
		var changeProduct = function(d) {
			if (d === -1) {
				at--;
				at += (total - 1);
				at %= total;
				at++;
				var firstOne = ((at - 1 + total - 1) % total) + 1;
				var categoryIndex = getCategory(firstOne);
				$productNav.prepend('' +
					'<img src="/img/imgmin/product/' +
					categories[categoryIndex].name +
					'/' +
					(firstOne - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)) +
					'.png" />' +
					'');
				$productNav.find("> img:last-child").remove();
				$productNav.find("> img").off('click');
				$productNav.find("> img:first-child").on('click', function() {changeProduct(-1);});
				$productNav.find("> img:last-child").on('click', function() {changeProduct(1);});
				categoryIndex = getCategory(at);
				window.history.pushState({at: at}, "",
					'/product/' +
					categories[categoryIndex].name +
					'/' +
					(at - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)));
				updateImage(at);
			}
			else if (d === 1) {
				at %= total;
				at++;
				var lastOne = ((at - 1 + total + cycle - 2) % total) + 1;
				var categoryIndex = getCategory(lastOne);
				$productNav.append('' +
					'<img src="/img/imgmin/product/' +
					categories[categoryIndex].name +
					'/' +
					(lastOne - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)) +
					'.png" />' +
					'');
				$productNav.find("> img:first-child").remove();
				$productNav.find("> img").off('click');
				$productNav.find("> img:first-child").on('click', function() {changeProduct(-1);});
				$productNav.find("> img:last-child").on('click', function() {changeProduct(1);});
				categoryIndex = getCategory(at);
				window.history.pushState({at: at}, "",
					'/product/' +
					categories[categoryIndex].name +
					'/' +
					(at - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)));
				updateImage(at);
			}
		}

		var $upArrow = $("#up-arrow");
		$upArrow.hover(function () {
			$(this).css('background-color', '#58667B').find('> img').attr('src', '/img/product/up-arrow-white.png');
		}, function () {
			$(this).css('background-color', 'transparent').find('> img').attr('src', '/img/product/up-arrow-grey.png');
		});
		$upArrow.on('click', function() {changeProduct(-1);});

		var $downArrow = $("#down-arrow");
		$downArrow.hover(function () {
			$(this).css('background-color', '#58667B').find('> img').attr('src', '/img/product/down-arrow-white.png');
		}, function () {
			$(this).css('background-color', 'transparent').find('> img').attr('src', '/img/product/down-arrow-grey.png');
		});
		$downArrow.on('click', function() {changeProduct(1);});

		document.onkeydown = function(e) {
			e = e || window.event;
			if (e.keyCode === 38) {
				e.preventDefault();
				changeProduct(-1);
			}
			else if (e.keyCode === 40) {
				e.preventDefault();
				changeProduct(1);
			}
		}

		window.onpopstate = function(event) {
			if (event.state === null) at = window.location.href.split('/').slice(-1)[0];
			else at = event.state.at;
			$productNav.html('');
			for (var d = -1; d < Math.min(cycle - 1, total - 1); d++) {
				var AT = (((at + total + d - 1) % total) + 1);
				var categoryIndex = getCategory(AT);
				$productNav.append('' +
					'<img src="/img/imgmin/product/' +
					categories[categoryIndex].name +
					'/' +
					(AT - (categoryIndex > 0 ? categories[categoryIndex - 1].till : 0)) +
					'.png" />' +
					'');
			}
			updateImage(at);
		};
	});
</script>